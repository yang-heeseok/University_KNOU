name: Deploy to GitHub Pages

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: 'pages'
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build static site
              run: |
                  # Markdownì„ HTMLë¡œ ë³€í™˜
                  yarn build:docs

                  # ìƒì„±ëœ íŒŒì¼ë“¤ì„ docs í´ë”ë¡œ ë³µì‚¬
                  cp -r dist/* docs/

                  # ì¸ë±ìŠ¤ í˜ì´ì§€ ìƒì„±
                  node scripts/generate-index.js

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: './docs'

    deploy:
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

    notify:
        runs-on: ubuntu-latest
        needs: [build, deploy]
        if: always()
        steps:
            - name: Notify Slack
              if: success()
              uses: 8398a7/action-slack@v3
              with:
                  status: success
                  text: 'ğŸ‰ í•™ìŠµ ì•„ì¹´ì´ë¸Œê°€ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!'
                  webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

            - name: Notify Telegram
              if: success()
              uses: appleboy/telegram-action@master
              with:
                  to: ${{ secrets.TELEGRAM_CHAT_ID }}
                  token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
                  message: |
                      ğŸ‰ ë°©ì†¡í†µì‹ ëŒ€í•™êµ í•™ìŠµ ì•„ì¹´ì´ë¸Œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!

                      ğŸ“ ë³€ê²½ì‚¬í•­: ${{ github.event.head_commit.message }}
                      ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}
                      ğŸ”— ì‚¬ì´íŠ¸: ${{ steps.deployment.outputs.page_url }}

                      #í•™ìŠµì•„ì¹´ì´ë¸Œ #ìë™ë°°í¬

            - name: Notify on failure
              if: failure()
              uses: 8398a7/action-slack@v3
              with:
                  status: failure
                  text: 'âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
                  webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
